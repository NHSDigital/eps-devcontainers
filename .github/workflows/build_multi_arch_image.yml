name: Build and push docker image

on:
    workflow_call:

jobs:

    build_image:
        permissions:
            id-token: write
        runs-on: ${{ matrix.runner }}
        strategy:
            matrix:
                include:
                    - arch: amd64
                      runner: ubuntu-22.04
                    - arch: arm64
                      runner: ubuntu-22.04-arm
        steps:
            - name: Checkout code
              uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
              with:
                  fetch-depth: 0

            # use setup-node rather than asdf so that it works multi-arch
            - name: setup node
              uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f
              with:
                  node-version-file: .tool-versions
            - name: make install
              run: |
                make install-node

            - name: Build container
              run: |
                  make build-base-image
                  docker tag ghcr.io/nhsdigital/eps-devcontainer-base:latest ghcr.io/nhsdigital/eps-devcontainer-base:latest-${{ matrix.arch }}
                  docker save "ghcr.io/nhsdigital/eps-devcontainer-base:latest-${{ matrix.arch }}" -o eps-devcontainer-base-latest-${{ matrix.arch }}.img
              env:
                 GH_TOKEN: ${{ github.token }}
                 ARCHITECTURE: ${{ matrix.arch }}
            - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
              name: Upload docker images
              with:
                name: eps-devcontainer-base-latest-${{ matrix.arch }}.img
                path: |
                    eps-devcontainer-base-latest-${{ matrix.arch }}.img

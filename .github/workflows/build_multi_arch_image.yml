name: Build and push docker image

on:
    workflow_call:

jobs:
    get_asdf_version:
        runs-on: ubuntu-22.04
        outputs:
            asdf_version: ${{ steps.asdf-version.outputs.version }}
            tag_format: ${{ steps.load-config.outputs.TAG_FORMAT }}
        steps:
        - name: Checkout code
          uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

        - name: Get asdf version
          id: asdf-version
          run: echo "version=$(awk '!/^#/ && NF {print $1; exit}' .tool-versions.asdf)" >> "$GITHUB_OUTPUT"
        - name: Load config value
          id: load-config
          run: |
            TAG_FORMAT=$(yq '.TAG_FORMAT' .github/config/settings.yml)
            echo "TAG_FORMAT=$TAG_FORMAT" >> "$GITHUB_OUTPUT"

    build_image:
        permissions:
            id-token: write
        runs-on: ${{ matrix.runner }}
        needs: [get_asdf_version]
        strategy:
            matrix:
                include:
                    - arch: amd64
                      runner: ubuntu-22.04
                    - arch: arm64
                      runner: ubuntu-22.04-arm
        steps:
            - name: Checkout code
              uses: actions/checkout@v5
              with:
                  fetch-depth: 0

            # using git commit sha for version of action to ensure we have stable version
            - name: Install asdf
              uses: asdf-vm/actions/setup@b7bcd026f18772e44fe1026d729e1611cc435d47
              with:
                asdf_version: ${{ needs.get_asdf_version.outputs.asdf_version }}

            - name: Cache asdf
              uses: actions/cache@9255dc7a253b0ccc959486e2bca901246202afeb
              with:
                path: |
                    ~/.asdf
                key: ${{ runner.os }}-asdf-${{ hashFiles('**/.tool-versions') }}
                restore-keys: |
                    ${{ runner.os }}-asdf-${{ hashFiles('**/.tool-versions') }}

            - name: Install asdf dependencies in .tool-versions
              uses: asdf-vm/actions/install@b7bcd026f18772e44fe1026d729e1611cc435d47
              with:
                asdf_version: ${{ needs.get_asdf_version.outputs.asdf_version }}
              env:
                PYTHON_CONFIGURE_OPTS: --enable-shared

            - name: make install
              run: |
                make install

            - name: Build container
              run: |
                  make build-base-image
                  docker tag ghcr.io/nhsdigital/eps-devcontainer-base:latest ghcr.io/nhsdigital/eps-devcontainer-base:latest-${{ matrix.arch }}
                  docker save "ghcr.io/nhsdigital/eps-devcontainer-base:latest-${{ matrix.arch }}" -o eps-devcontainer-base-latest-${{ matrix.arch }}.img
              env:
                 GH_TOKEN: ${{ github.token }}
            - uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
              name: Upload docker images
              with:
                name: eps-devcontainer-base-latest-${{ matrix.arch }}.img
                path: |
                    eps-devcontainer-base-latest-${{ matrix.arch }}.img
